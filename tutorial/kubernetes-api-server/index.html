
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Inlets Secure Tunnels From Dev to Cloud">
      
      
        <meta name="author" content="OpenFaaS Ltd">
      
      
        <link rel="canonical" href="https://docs.inlets.dev/tutorial/kubernetes-api-server/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.6">
    
    
      
        <title>Tutorial: Expose a local Kubernetes API Server - Inlets</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.9d5733d3.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto,+Helvetica:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto, Helvetica";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-60759269-5","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorial-expose-a-local-kubernetes-api-server" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Inlets" class="md-header__button md-logo" aria-label="Inlets" data-md-component="logo">
      
  <img src="../../images/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inlets
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial: Expose a local Kubernetes API Server
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/inlets" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    inlets/inlets
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Inlets" class="md-nav__button md-logo" aria-label="Inlets" data-md-component="logo">
      
  <img src="../../images/logo.svg" alt="logo">

    </a>
    Inlets
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/inlets" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    inlets/inlets
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Overview
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Overview" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Overview
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/reference/faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/manual-http-server/" class="md-nav__link">
        Manual HTTP tunnel server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/automated-http-server/" class="md-nav__link">
        Automated HTTP tunnel server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/dual-tunnels/" class="md-nav__link">
        Dual TCP and HTTP tunnels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/caddy-http-tunnel/" class="md-nav__link">
        Custom reverse proxy with Caddy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/kubernetes-ingress/" class="md-nav__link">
        Kubernetes Ingress
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/kubernetes-api-server/" class="md-nav__link">
        Kubernetes API Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/postgresql-tcp-tunnel/" class="md-nav__link">
        Tunnel Postgresql
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/ssh-tcp-tunnel/" class="md-nav__link">
        Tunnel SSH
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/tutorial/community/" class="md-nav__link">
        Community tutorials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/reference/inlets-operator/" class="md-nav__link">
        Inlets Operator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/reference/inletsctl/" class="md-nav__link">
        inletsctl
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="tutorial-expose-a-local-kubernetes-api-server">Tutorial: Expose a local Kubernetes API Server<a class="headerlink" href="#tutorial-expose-a-local-kubernetes-api-server" title="Permanent link">&para;</a></h1>
<p>In this tutorial, we'll show you how to expose a local Kubernetes API Server on the Internet, so that you can access it from anywhere, just like with a managed cloud provider.</p>
<h2 id="pre-reqs">Pre-reqs<a class="headerlink" href="#pre-reqs" title="Permanent link">&para;</a></h2>
<ul>
<li>A computer or laptop running MacOS or Linux, or Git Bash or WSL on Windows</li>
<li>Docker for Mac / Docker Daemon - installed in the normal way, you probably have this already</li>
<li>Kubernetes running locally with kubeadm, K3s, K3d, Minikube, KinD, Docker Desktop, etc</li>
</ul>
<h2 id="the-kubernetes-cluster">The Kubernetes cluster<a class="headerlink" href="#the-kubernetes-cluster" title="Permanent link">&para;</a></h2>
<p>By default every Kubernetes cluster has TLS enabled to encrypt any HTTP REST messages that go over its control-plane. The TLS certificate has to be bound to a certain name, sometimes called a TLS SAN.</p>
<p>The certificate is usually only valid for "kubernetes.default.svc", and can only be accessed from within the cluster.</p>
<p><img alt="Kubernetes on tour" src="https://blog.alexellis.io/content/images/2021/08/inlets-direct.png" /></p>
<blockquote>
<p>Kubernetes on tour - get access to your cluster from anywhere, without having to resort to complex tooling like VPNs.</p>
</blockquote>
<p>When a managed cloud provider provisions you a cluster, they'll add additional names into the certificate like "customer1.lke.eu.linode.com" which is then added to your generated kubeconfig file that you download in the dashboard.</p>
<p>We have five steps run through to expose the API server:</p>
<p>1) Create a Kubernetes cluster
2) Create a VM on the public cloud with an inlets TCP server running on it
3) Create a DNS entry for the public VM's IP address
4) Configure a TLS SAN, if possible with a new domain name
5) Set up an inlets client as a Pod to forward traffic to the Kubernetes API Server</p>
<p>Once we have all this in place, we can take our existing kubeconfig file and edit the URL, so that instead of pointing at our LAN IP or localhost, it points to the domain mapped to the public VM.</p>
<h2 id="create-a-cluster">Create a cluster<a class="headerlink" href="#create-a-cluster" title="Permanent link">&para;</a></h2>
<p>You can create a cluster on any machine by using KinD:</p>
<div class="highlight"><pre><span></span><code>arkade get kind
kind create cluster
</code></pre></div>
<p>If you have a Raspberry Pi or a Linux Server, you can install K3s using <code>k3sup</code>:</p>
<div class="highlight"><pre><span></span><code>arkade get k3sup

k3sup install --ip <span class="m">192</span>.168.1.101 --user pi
</code></pre></div>
<p>In either case, you'll get back a kubeconfig file.</p>
<p>Here's a snippet of what I got back from running <code>k3sup install</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">clusters</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://192.168.1.101:6443</span><span class="w"></span>
</code></pre></div>
<p>The server field will need to be changed to the new public address later on.</p>
<h2 id="create-a-vm-on-the-public-cloud-with-an-inlets-tcp-server-running-on-it">Create a VM on the public cloud with an inlets TCP server running on it<a class="headerlink" href="#create-a-vm-on-the-public-cloud-with-an-inlets-tcp-server-running-on-it" title="Permanent link">&para;</a></h2>
<p>Just like when Linode Kubernetes Engine provisions us a domain like <code>"customer1.lke.eu.linode.com"</code>, we'll need our own subdomain too, so that the certificate can be issued for it.</p>
<p>In order to create the DNS record, we a public IP which we will get by creating a tunnel server on our preferred cloud and in a <a href="https://www.linode.com/docs/api/regions/">region that's close to us</a>.</p>
<div class="highlight"><pre><span></span><code>arkade get inletsctl

<span class="nb">export</span> <span class="nv">ACCESS_TOKEN</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="c1"># Retreive this from your cloud dashboard</span>

inletsctl create <span class="se">\</span>
  --provider linode <span class="se">\</span>
  --tcp <span class="se">\</span>
  --access-token <span class="nv">$ACCESS_TOKEN</span> <span class="se">\</span>
  --region eu-west
</code></pre></div>
<p>Save the connection info from inletsctl into a text file for later.</p>
<div class="highlight"><pre><span></span><code># Give a single value or comma-separated
export PORTS=&quot;8000&quot;

# Where to route traffic from the inlets server
export UPSTREAM=&quot;localhost&quot;

inlets-pro tcp client --url &quot;wss://139.160.201.143:8123&quot; \
  --token &quot;f2cXtOouRpuVbAn4arVvdSMx//uKD3jDnssr3X9P338&quot; \
  --upstream $UPSTREAM \
  --ports $PORTS
</code></pre></div>
<p>Create a DNS subdomain for the IP address you were given:</p>
<ul>
<li><code>k3s.example.com</code> =&gt; <code>139.160.201.143</code></li>
</ul>
<p>Check that you can resolve the IP with a ping <code>ping -c 1 k3s.example.com</code></p>
<p>Now check the status of the inlets server:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">TOKEN</span><span class="o">=</span><span class="s2">&quot;f2cXtOouRpuVbAn4arVvdSMx//uKD3jDnssr3X9P338&quot;</span>

inlets-pro status --url <span class="s2">&quot;wss://139.160.201.143:8123&quot;</span> <span class="se">\</span>
  --token <span class="s2">&quot;</span><span class="nv">$TOKEN</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>inlets server status. Version: <span class="m">0</span>.9.3 - 8e96997499ae53c6fb2ae9f9e13fa9b48dcb6514

Server info:
Hostname:       localhost
Process uptime: <span class="m">5</span> seconds ago
Mode:           tcp
Version:        <span class="m">0</span>.9.3 8e96997499ae53c6fb2ae9f9e13fa9b48dcb6514

No clients connected.
</code></pre></div>
<p>We can now move onto the next step.</p>
<h2 id="configure-a-tls-san-if-possible-with-a-new-domain-name">Configure a TLS SAN, if possible with a new domain name<a class="headerlink" href="#configure-a-tls-san-if-possible-with-a-new-domain-name" title="Permanent link">&para;</a></h2>
<p>With k3s, it's trivial to add additional TLS SAN names for the Kubernetes API Server.</p>
<p>If you run the <code>k3sup install</code> command again, it'll update your configuration:</p>
<div class="highlight"><pre><span></span><code>k3sup install <span class="se">\</span>
  --ip <span class="m">192</span>.168.1.101 <span class="se">\</span>
  --user pi <span class="se">\</span>
  --tls-san k3s.example.com
</code></pre></div>
<p>You'll now have the custom domain along with the default <code>kubernetes.default.svc</code> as valid names in the generated certificate.</p>
<p>If you're not running on k3s, or use a service where you cannot change the TLS SAN, then we'll show you what to do in the next step.</p>
<h2 id="update-your-kubeconfig-file-with-the-new-endpoint">Update your kubeconfig file with the new endpoint<a class="headerlink" href="#update-your-kubeconfig-file-with-the-new-endpoint" title="Permanent link">&para;</a></h2>
<p>We need to update our kubeconfig file to point at the custom domain instead of at whatever loopback or LAN address it currently does.</p>
<p>For K3s users, change the server URL:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">clusters</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://192.168.1.101:6443</span><span class="w"></span>
</code></pre></div>
<p>To:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">clusters</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://k3s.example.com:443</span><span class="w"></span>
</code></pre></div>
<p>For any user where you cannot regenerate the TLS certificate for the API Server, you can specify the server name in the config file:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">clusters</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://k3s.example.com:443</span><span class="w"></span>
<span class="w">    </span><span class="nt">tls-server-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k3s.example.com</span><span class="w"></span>
</code></pre></div>
<p>For more details see: <a href="https://github.com/kubernetes/kubernetes/pull/88769">Support TLS Server Name overrides in kubeconfig file #88769</a></p>
<p>Save the changes to your kubeconfig file.</p>
<h2 id="connect-the-tunnel">Connect the tunnel<a class="headerlink" href="#connect-the-tunnel" title="Permanent link">&para;</a></h2>
<p>The tunnel acts like a router, it takes any TCP packets sent to port 6443 (k3s) or 443 (Kubernetes) and forwards them down the tunnel to the inlets client. The inlets client then looks at its own "--upstream" value to decide where to finally send the data.</p>
<p>Save <code>inlets-k8s-api.yaml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">LICENSE</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat <span class="nv">$HOME</span>/.inlets/LICENSE<span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">export</span> <span class="nv">TOKEN</span><span class="o">=</span><span class="s2">&quot;f2cXtOouRpuVbAn4arVvdSMx//uKD3jDnssr3X9P338&quot;</span> <span class="c1"># populate with the token from inletsctl</span>
<span class="nb">export</span> <span class="nv">SERVER_IP</span><span class="o">=</span><span class="s2">&quot;139.160.201.143&quot;</span> <span class="c1"># populate with the server IP, not the domain</span>

cat &gt; inlets-k8s-api.yaml <span class="s">&lt;&lt;EOF</span>
<span class="s">---</span>
<span class="s">apiVersion: apps/v1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s">  name: inlets-client</span>
<span class="s">spec:</span>
<span class="s">  replicas: 1</span>
<span class="s">  selector:</span>
<span class="s">    matchLabels:</span>
<span class="s">      app: inlets-client</span>
<span class="s">  template:</span>
<span class="s">    metadata:</span>
<span class="s">      labels:</span>
<span class="s">        app: inlets-client</span>
<span class="s">    spec:</span>
<span class="s">      containers:</span>
<span class="s">      - name: inlets-client</span>
<span class="s">        image: ghcr.io/inlets/inlets-pro:0.9.3</span>
<span class="s">        imagePullPolicy: IfNotPresent</span>
<span class="s">        command: [&quot;inlets-pro&quot;]</span>
<span class="s">        args:</span>
<span class="s">        - &quot;tcp&quot;</span>
<span class="s">        - &quot;client&quot;</span>
<span class="s">        - &quot;--url=wss://$SERVER_IP:8123&quot;</span>
<span class="s">        - &quot;--upstream=kubernetes.default.svc&quot;</span>
<span class="s">        - &quot;--port=443&quot;</span>
<span class="s">        - &quot;--port=6443&quot;</span>
<span class="s">        - &quot;--token=$TOKEN&quot;</span>
<span class="s">        - &quot;--license=$LICENSE&quot;</span>
<span class="s">---</span>
<span class="s">EOF</span>
</code></pre></div>
<p>You'll see the tunnel client up and running and ready to receive requests:</p>
<div class="highlight"><pre><span></span><code>kubectl logs deploy/inlets-client
2022/06/24 09:51:18 Licensed to: Alex &lt;contact@openfaas.com&gt;, expires: 128 day(s)
2022/06/24 09:51:18 Upstream server: kubernetes.default.svc, for ports: 443, 6443
time=&quot;2022/06/24 09:51:18&quot; level=info msg=&quot;Connecting to proxy&quot; url=&quot;wss://139.160.201.143:8123/connect&quot;
inlets-pro TCP client. Copyright OpenFaaS Ltd 2021
time=&quot;2022/06/24 09:51:18&quot; level=info msg=&quot;Connection established&quot; client_id=5309466072564c1c90ce0a0bcaa22b74
</code></pre></div>
<p>Check the tunnel server's status to confirm the connection:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">TOKEN</span><span class="o">=</span><span class="s2">&quot;f2cXtOouRpuVbAn4arVvdSMx//uKD3jDnssr3X9P338&quot;</span>

inlets-pro status --url <span class="s2">&quot;wss://139.160.201.143:8123&quot;</span> <span class="se">\</span>
  --token <span class="s2">&quot;</span><span class="nv">$TOKEN</span><span class="s2">&quot;</span>

inlets server status. Version: <span class="m">0</span>.9.3 - 8e96997499ae53c6fb2ae9f9e13fa9b48dcb6514

Server info:
Hostname:       localhost
Process uptime: <span class="m">15</span> minutes ago
Mode:           tcp
Version:        <span class="m">0</span>.9.3 8e96997499ae53c6fb2ae9f9e13fa9b48dcb6514

Connected clients:
Client ID                        Remote Address        Connected  Upstreams
5309466072564c1c90ce0a0bcaa22b74 <span class="m">192</span>.168.1.101:16368 <span class="m">43</span> seconds kubernetes.default.svc:443, kubernetes.default.svc:6443
</code></pre></div>
<p>Finally prove that it's working with the new, public address:</p>
<div class="highlight"><pre><span></span><code>$ kubectl cluster-info
Kubernetes control plane is running at https://k3s.example.com:443
CoreDNS is running at https://k3s.example.com:443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://k3s.example.com:443/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy

To further debug and diagnose cluster problems, use <span class="s1">&#39;kubectl cluster-info dump&#39;</span>.
</code></pre></div>
<h2 id="wrapping-up">Wrapping up<a class="headerlink" href="#wrapping-up" title="Permanent link">&para;</a></h2>
<p>In a relatively short period of time, with a custom domain, and a small VM, we set up a tunnel server to route traffic from the public Internet to a K3s server on an internal network.</p>
<p>This gives you a similar experience to a managed public cloud Kubernetes engine, but running on your own infrastructure, or perhaps within a restrictive VPC.</p>
<p>You may also like:</p>
<ul>
<li><a href="https://inlets.dev/blog/2021/06/02/argocd-private-clusters.html">Learn how to manage apps across multiple Kubernetes clusters</a> by Johan Siebens</li>
</ul>
<p>If you'd like to talk to us about this tutorial, feel free to reach out for a meeting:</p>
<p><a href="/contact">Set up a meeting</a></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 OpenFaaS Ltd

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.sections", "toc.integrate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.5e67fbfe.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.e87a5f81.min.js"></script>
      
    
  </body>
</html>